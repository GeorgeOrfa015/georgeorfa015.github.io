<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OASA TELEMATICS but better</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap');

        ::-webkit-scrollbar {
            display: none;
        }


        body{
            background-color: #000;
            color: #fff;
            font-family: "Manrope";
            font-size: 1vw;
        }
        div{
            border: 0px solid red;
        }
        #date{
            position: fixed;
            bottom: 0.1vw;
            right: 0.1vw;
        }
        #outerCont{
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1vw;
        }
        .innerCont{
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto;
            gap: 0.5vw;
            padding: 0.5vw;
            height: fit-content;
            overflow-y: scroll;
            max-height: 15.5vw;
        }
        
        .item{
            display: grid;
            grid-template-columns: auto 2fr auto;
            height: fit-content;
        }
        .LineID{
            background-color: #056c30;
            width: 2.5vw;
            padding: 0.5vw;
            border-radius: 0.2vw;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            
        }
        .LineName{
            padding: 0.5vw;
        }
        .ArrivalTime{
            padding: 0.5vw;
            text-align: right;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .module{
            display: grid;
            background: #222;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            border-radius: 0.5vw;
            overflow: hidden;
            height: 20vw;
        }
        .header{
            background: #444;
            text-align: center;
            font-weight: 500;
            font-size: 1.5vw;
            padding: 0.5vw;
            height: 2.5vw;
            display: flex;
            justify-content: center;
            align-items: center;

        }
        .none{
            text-align: center;
            font-size: 1.25vw;
            color: #ddd;
        }
        @media(max-width:700px) {
            #outerCont{
                grid-template-columns: 1fr;
                gap: 2vw;
            }
            .module{
                border-radius: 2vw;
                height: 60vw;
            }
            .header{
                height: 9vw;
                font-size: 6vw;
                font-weight: 800;
            }
            .LineName, .LineID, .ArrivalTime{
                font-size: 3.5vw;
            }
            .LineID{
                width: 10vw;
                border-radius: 1.5vw;
            }
            .innerCont{
                gap: 2vw;
                padding: 2vw;
                max-height: 46vw;
            }
            .item{
                gap: 1vw;
            }
            .none{
                font-size: 3.5vw;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            #date{
                text-align: center;
                font-size: 2.5vw;
                width: fit-content;
                backdrop-filter: blur(3px);
                left: 50%;
                transform: translateX(-50%);
                padding: 2vw;
                border-radius: 5vw;
                border: 0.05vw #333 solid;
                bottom: 1vw;
            }
        }

    </style>
</head>
<body>
    <div id="outerCont">

    </div>
    <div id="date">
        Fetching data...
    </div>
    <script>
        delay = 20000

        let trolleyList = [
            "1",
            "2",
            "3",
            "4",
            "5",
            "6",
            "10",
            "11",
            "12",
            "14",
            "15",
            "16",
            "17",
            "18",
            "19",
            "19Β",
            "20",
            "21",
            "24",
            "25",
        ]
        async function getData(url) {
            const ts = Date.now();

            const response = await fetch(
                "https://corsproxy.io/?" +
                encodeURIComponent(
                    `http://telematics.oasa.gr/api/?act=${url}&_=${ts}`
                ),
                {
                    cache: "no-store"
                }
            );

            return response.json();
        }


        async function getStopNameAndXY(id) {
            return await getData("getStopNameAndXY&p1="+id);
        }
        async function getStopArrivals(id) {
            return await getData("getStopArrivals&p1="+id);
        }
        async function webRoutesForStop(id) {
            return await getData("webRoutesForStop&p1="+id);
        }
        
        async function createArrivals(stop_id) {
            let cont = document.getElementById("innerCont"+stop_id)
            let header = document.getElementById("header"+stop_id)

            header.style.background = "#555"
            
            let routes = await webRoutesForStop(stop_id);
            let arrivals = await getStopArrivals(stop_id);
            
            header.style.background = "#444"
            cont.innerHTML=''
            
            if (arrivals!=null) {
                arrivals.forEach(element => { // FIRST LOOP
                    let name;
                    let number;
                    code = element.route_code
                    routes.forEach(route => { // SECOND LOOP
                        if (code == route.RouteCode) {
                            name = route.RouteDescr
                            number = route.LineID
                        }
                    });
                    console.log(name)
                    console.log(number)

                    let mins = element.btime2
                    // "Frontend"
                    let item = document.createElement("div")
                    item.className = "item";
                    
                    let LineID = document.createElement("div")
                    LineID.innerHTML = number;
                    LineID.className = "LineID";
                    if (trolleyList.includes(number)) {
                        LineID.style.background = "#f0991f"
                    }
                    
                    let LineName = document.createElement("span");
                    LineName.innerHTML = name;
                    LineName.className = "LineName";
                    
                    let ArrivalTime = document.createElement("div");
                    ArrivalTime.innerHTML = mins+"'";
                    ArrivalTime.className = "ArrivalTime";

                    item.appendChild(LineID)
                    item.appendChild(LineName);
                    item.appendChild(ArrivalTime);
                    cont.appendChild(item)

                });
            }else{
                let item = document.createElement("div");
                item.style.gridColumn = "span 3";
                item.innerHTML = "Δεν αναμένονται αφίξεις."
                item.className = "none"
                cont.appendChild(item);
            }
            if (routes=null) {
                let item = document.createElement("div");
                item.style.gridColumn = "span 3";
                item.innerHTML = "Αδυναμία φόρτωσης δεδομένων"
                item.className = "none"
                cont.appendChild(item);

            }
        
            document.getElementById("date").innerHTML = "Last refreshed: "+`${new Date().getFullYear()}-${("0" + new Date().getMonth()+1).slice(-2)}-${("0" + new Date().getDate()).slice(-2)} ${("0" + new Date().getHours()).slice(-2)}:${("0" + new Date().getMinutes()).slice(-2)}:${("0" + new Date().getSeconds()).slice(-2)}`;
        }
        async function createWidget(stop_id, order) {
            let module = document.createElement("div");
            module.className = "module";
            module.style.order = order

            let stop = await getStopNameAndXY(stop_id)
            let header = document.createElement("div");
            header.innerHTML = stop[0].stop_descr;
            header.className = "header"
            header.id = "header"+stop_id

            let innerCont = document.createElement("div")
            innerCont.className = "innerCont";
            innerCont.id = "innerCont"+stop_id

            module.appendChild(header)
            module.appendChild(innerCont)
            document.getElementById("outerCont").appendChild(module)
            await createArrivals(stop_id)
            setInterval(async function() {await createArrivals(stop_id)}, delay);
        }

        list = [
            "090138",
            "060905",
            "481194",
            "",
            "140057",
            "480050"
        ]
        list = ["061040", "400087", "060299"]
        i = 0;

        list.forEach(code => {
            newWidget(code);
        });
        function newWidget(stop_id) {
            createWidget(stop_id, i+1)
            i++;
        }
    </script>
</body>
</html>
