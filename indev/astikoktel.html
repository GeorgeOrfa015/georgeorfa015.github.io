<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTIKO KTEL TELEMATICS but better</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap');

        ::-webkit-scrollbar {
            display: none;
        }


        body{
            background-color: #000;
            color: #fff;
            font-family: "Manrope";
            font-size: 1vw;
        }
        div{
            border: 0px solid red;
        }
        #date{
            position: fixed;
            bottom: 0.1vw;
            right: 0.1vw;
        }
        #outerCont{
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1vw;
        }
        .innerCont{
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto;
            gap: 0.5vw;
            padding: 0.5vw;
            height: fit-content;
            overflow-y: scroll;
            max-height: 15.5vw;
            width: calc(100% - 1vw);
        }
        
        .item{
            display: grid;
            grid-template-columns: auto 2fr auto;
            height: fit-content;
            max-width: 100%;
            background: #292929;
            border-radius: 0.2vw;
        }
        .LineID{
            background-color: #056c30;
            width: 1.5vw;
            padding: 0.2vw 0.5vw;
            border-radius: 0.2vw;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            
        }
        .LineNameCont{
            display: grid;
            padding: 0.2vw 0.5vw;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
        }
        .LineName{
            font-size: 1vw;
            display: inline-block;
        }
        .ArrivalTimeCont{
            padding: 0.2vw 0.5vw;
            text-align: right;
            display: grid;
        }
        .ArrivalTime{
            font-size: 1vw;
        }
        .ArrivalDate{
            font-size: 0.85vw;
            color: #bbb;
        }
        .module{
            display: grid;
            background: #222;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            border-radius: 0.5vw;
            overflow: hidden;
            height: 20vw;
        }
        .header{
            background: #444;
            text-align: center;
            font-weight: 500;
            font-size: 1.25vw;
            padding: 0.5vw;
            height: 2.5vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
        }
        .headerText{
            white-space: nowrap;
            display: inline-block;
            width: max-content;
        }
        .scroll{
            animation: scroll-text 8s ease-in-out infinite;
            animation-direction: alternate;
        }
        .scrollLine{
            animation: scroll-line 8s ease-in-out infinite;
            animation-direction: alternate;
        }
        @keyframes scroll-text {
        0%   { transform: translateX(15%); }
        100% { transform: translateX(-15%); }
        }

        @keyframes scroll-line {
        0%   { transform: translateX(0%); }
        100%   { transform: translateX(-10%); }
        }
        .none{
            text-align: center;
            font-size: 1.25vw;
            color: #fff;
        }
        .gps{
            color: #bbb;
            font-size: 0.85vw;
        }
        .live{
            color: #30d158
        }
        @media(max-width:700px) {
            #outerCont{
                grid-template-columns: 1fr;
                gap: 2vw;
            }
            .module{
                border-radius: 2vw;
                height: 64.5vw;
            }
            .header{
                height: 9vw;
                font-size: 4vw;
                font-weight: 800;
            }
            .LineName, .ArrivalTime{
                font-size: 3.9vw;
                font-weight: 400;
            }
            .ArrivalTimeCont{
                padding-left: 1vw;
            }
            .LineNameCont{
                width: 100%;
                white-space: nowrap;
            }
            .LineID{
                width: 10vw;
                border-radius: 1.5vw;
                font-size: 4vw;
                padding: 0vw;
            }
            .innerCont{
                gap: 2vw;
                padding: 2vw;
                max-height: 50.5vw;
                width: calc(100% - 4vw);
            }
            .item{
                gap: 1.5vw;
                max-width: 100%;
                border-radius: 1.5vw;
            }
            .none{
                font-size: 3.5vw;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            #date{
                text-align: center;
                font-size: 3vw;
                width: fit-content;
                backdrop-filter: blur(0.4vw);
                left: 50%;
                transform: translateX(-50%);
                padding:  2vw 4vw;
                border-radius: 5vw;
                background-color: #2225;
                box-shadow: inset 0 0 0.6vw #fff3;
                white-space: nowrap;
                font-weight: 600;;
            }
            .gps, .ArrivalDate{
                font-size: 3.5vw;
            }
            @keyframes scroll-text {
            0%   { transform: translateX(20%); }
            100% { transform: translateX(-20%); }
            }

            @keyframes scroll-line {
            0%   { transform: translateX(0%); }
            100%   { transform: translateX(-30%); }
            }
        }

    </style>
</head>
<body>
    <div id="outerCont">

    </div>
    <div id="date">
        Fetching data...
    </div>
    <script>
        delay = 20000
        let testValue = {
            "vehicles":[
                {
                    "vehicleCode":"20260105_31015_1000000_23_15",
                    "borderColor":"#AC0000",
                    "longitude":"25.124617",
                    "latitude":"35.336471",
                    "departureSeconds":53,
                    "lineName":"AIRPORT",
                    "departureMins":3,
                    "routeCode":"31015",
                    "routeName":"HERAKLION HOSPITAL (PAGNI) - AIRPORT",
                    "lineCode":"06",
                    "lineColor":"#2e7d32",
                    "lineTextColor":"#ffffff"
                },
                {
                    "vehicleCode":"20260105_31015_1000000_23_15",
                    "borderColor":"#AC0000",
                    "longitude":"25.124617",
                    "latitude":"35.336471",
                    "departureSeconds":53,
                    "lineName":"AIRPORT",
                    "departureMins":5,
                    "routeCode":"31015",
                    "routeName":"GAZI - AIRPORT",
                    "lineCode":"11",
                    "lineColor":"#b71c1c",
                    "lineTextColor":"#ffffff"
                },
                {
                    "vehicleCode":"20260105_31009_1000000_23_15",
                    "borderColor":"#AC0000",
                    "longitude":"25.081521",
                    "latitude":"35.335661",
                    "departureSeconds":34,
                    "lineName":"AIRPORT",
                    "departureMins":13,
                    "routeCode":"31018",
                    "routeName":"AMOUDARA - AIRPORT",
                    "lineCode":"50",
                    "lineColor":"#787878",
                    "lineTextColor":"#ffffff"
                }
            ]
        }

        function calcDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const toRad = deg => deg * Math.PI / 180;

            const f1 = toRad(lat1);
            const f2 = toRad(lat2);
            const Df = toRad(lat2 - lat1);
            const Dl = toRad(lon2 - lon1);

            const a =
                Math.sin(Df / 2) ** 2 +
                Math.cos(f1) * Math.cos(f2) *
                Math.sin(Dl / 2) ** 2;

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }


        async function getData(key, id) {
            const response = await fetch(
                "https://corsproxy.io/?https://rest.citybus.gr/api/v1/el/110/stops/live/" + id,
                {
                    cache: "no-store",
                    headers: {
                        "Authorization": key,
                        "Cache-Control": "no-cache, no-store, must-revalidate",
                        "Pragma": "no-cache",
                        "Expires": "0"
                    }
                }
            );


            // return testValue;
            // if (!response.ok) {
            //     throw new Error(`HTTP error: ${response.status}`);
            // }

            return await response.json();
        }
        
        
        async function getHTML(id) {
            const url = "https://corsproxy.io/?https://irakleio.citybus.gr/stops/live/"+id;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error: ${response.status}`);
            }
            
            return await response.text();
        }
        function updateScroll(ticker, element, className) {
            const span = ticker.querySelector(element);
            span.classList.toggle(
                className,
                span.scrollWidth > ticker.clientWidth
            );
        }

        let colorDict = {
            L01: "#c42a19",
            L02: "#7e786f",
            L03: "#8c705d",
            L04: "#570096",
            L05: "#7e0d48",
            L06: "#4b8136",
            L07: "#6483db",
            L09: "#360408",
            L10: "#7e786f",
            L11: "#d82e5c",
            L12: "#2e4bf2",
            L14: "#7e786f",
            L15: "#487f83",
            L16: "#4c007d",
            L17: "#e89c31",
            L19: "#5300d9",
            L20: "#6fb454",
            L23: "#23211e",
            L21: "#e24172",
            L31: "#4f585c",
            L50: "#000080",
            L91: "#dd6059",
            L92: "#5f6ee5",
            L93: "#65c251"
        }
        let stop_id = "9911"
        function createWidget(stop_id, order) {
            
            getHTML(stop_id).then(html => {
                let name = html.split("Στάση:<br/><span>")[1].split("</span>'")[0]
                let stopLat = html.split("'latitude': ")[1].split(",")[0]
                let stopLong = html.split("'longitude': ")[1].split(",")[0]

                let module = document.createElement("div");
                module.className = "module";
                module.style.order = order

                let header = document.createElement("div");
                header.className = "header"
                header.id = "header"+stop_id

                let headerText = document.createElement("span");
                headerText.innerHTML = name;
                headerText.className = "headerText"

                let innerCont = document.createElement("div")
                innerCont.className = "innerCont";
                innerCont.id = "innerCont"+stop_id


                header.appendChild(headerText)
                document.fonts.ready.then(() => {
                    updateScroll(header, 'span', 'scroll');
                });
                module.appendChild(header)
                module.appendChild(innerCont)
                document.getElementById("outerCont").appendChild(module)
                
                function loop() {
                    
                    header.style.background = "#555"
                    
                    getData("Bearer " + html.split("token = '")[1].split("';")[0],stop_id).then(data => {
                        header.style.background = "#444"
                        innerCont.innerHTML = ""
                        
                        data.vehicles.forEach(route => {
                            
                            console.table(route)
                            console.log(route.lineCode)
                            console.log(route.routeName)
                            console.log(route.departureMins)
                            
                            let mins = route.departureMins
                            let name = route.routeName
                            let number = route.lineCode
                            let color = route.lineColor
                            let busLat = route.latitude
                            let busLong = route.longitude
                            let distance, isLocationAvailable;
                            
                            if (busLong != 0) {
                                distance = calcDistance(busLat, busLong, stopLat, stopLong).toFixed(2);
                                if (distance >= 0) {
                                    distance = (distance/1000).toFixed(1)+" km"
                                }else{
                                    distance = distance + " m"
                                }
                                isLocationAvailable = true
                            }else{
                                distance = "No GPS data"
                                isLocationAvailable = false
                            }
                            console.log(distance)
                            
                            let item = document.createElement("div")
                            item.className = "item";
                            
                            let LineID = document.createElement("div")
                            LineID.innerHTML = number;
                            LineID.style.background = colorDict["L"+number]
                            LineID.className = "LineID"
                            
                            let LineNameCont = document.createElement("div");
                            LineNameCont.className = "LineNameCont";
                            
                            let LineName = document.createElement("span");
                            LineName.innerHTML = name;
                            LineName.className = "LineName";

                            
                            let LineDistance = document.createElement("span");
                            LineDistance.innerHTML = distance;
                            if (isLocationAvailable) {
                                LineDistance.className = "gps live";
                            }else{
                                LineDistance.className = "gps";
                            }

                            let ArrivalTimeCont = document.createElement("div")
                            ArrivalTimeCont.className = "ArrivalTimeCont"

                            let ArrivalTime = document.createElement("span");
                            ArrivalTime.innerHTML = mins+"'";
                            ArrivalTime.className = "ArrivalTime"

                            let timeNow = new Date(new Date().getTime()+(mins*60000))

                            let ArrivalDate = document.createElement("span")
                            ArrivalDate.className = "ArrivalDate"
                            ArrivalDate.innerHTML = `${("0" + timeNow.getHours()).slice(-2)}:${("0" + timeNow.getMinutes()).slice(-2)}`
                            
                            item.appendChild(LineID)
                            LineNameCont.appendChild(LineName)
                            LineNameCont.appendChild(LineDistance)
                            item.appendChild(LineNameCont);
                            document.fonts.ready.then(() => {
                                updateScroll(LineNameCont, ".LineName", 'scrollLine');
                            });
                            ArrivalTimeCont.appendChild(ArrivalTime)
                            ArrivalTimeCont.appendChild(ArrivalDate)
                            item.appendChild(ArrivalTimeCont);
                            innerCont.appendChild(item)
                            
                        })
                        document.getElementById("date").innerHTML = "Last update: "+`${new Date().getFullYear()}-${("0" + new Date().getMonth()+1).slice(-2)}-${("0" + new Date().getDate()).slice(-2)} ${("0" + new Date().getHours()).slice(-2)}:${("0" + new Date().getMinutes()).slice(-2)}:${("0" + new Date().getSeconds()).slice(-2)}`;
                    })
                    .catch(err => {
                        innerCont.innerHTML = ""
                        console.log("No arrivals in the next 30 minutes.")
                        let item = document.createElement("div");
                        item.style.gridColumn = "span 3";
                        item.innerHTML = "Δεν αναμένονται αφίξεις."
                        item.className = "none"
                        innerCont.appendChild(item);
                    })
                }
                loop();
                setInterval(loop, 20000)
            })
        }
        
        list = [
            "2215",
            "9911",
            "0714",
            "1030",
            "0307",
            "0110"
        ]
        let i = 0;
        list.forEach(code => {
            newWidget(code);
        });
        function newWidget(stop_id) {
            i++;
            createWidget(stop_id, i)
        }
        
        function updateAllScroll() {
            document.querySelectorAll(".header").forEach(header => {
                updateScroll(header, 'span', 'scroll');
            });

            document.querySelectorAll(".LineNameCont").forEach(cont => {
                updateScroll(cont, ".LineName", 'scrollLine');
            });
        }
        let resizeTimeout;
        window.addEventListener("resize", () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(updateAllScroll, 10);
        });

                
        
        // a rat was here
    </script>
</body>
</html>
